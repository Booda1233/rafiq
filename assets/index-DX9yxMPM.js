import{j as e,M as fe,r as m,R as Be,a as De}from"./react-DBkrbndE.js";import{G as Ue,T as O,e as pe,f as ge}from"./vendor-C9fFvcx1.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const u of s)if(u.type==="childList")for(const d of u.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&o(d)}).observe(document,{childList:!0,subtree:!0});function n(s){const u={};return s.integrity&&(u.integrity=s.integrity),s.referrerPolicy&&(u.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?u.credentials="include":s.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function o(s){if(s.ep)return;s.ep=!0;const u=n(s);fetch(s.href,u)}})();const Z=new Ue({apiKey:"AIzaSyAR9JheucJcud4oQU5MXdrfyvkwHtBTlaI"}),Le=(r,t,n=[])=>`
**شخصيتك: صديقك الذكي (شخصية متغيرة حسب الاسم)**

**1. تحديد هويتك (ده أهم جزء):**
*   **بص على اسمك: "${r}".**
*   **لو اسمك ولد (زي علي, كريم, أحمد):** اتكلم بصيغة **المذكر**. قول "**أنا صاحبك**"، "**موجود**"، "**عينيا ليك**".
*   **لو اسمك بنت (زي ندى, سارة, نور):** اتكلمي بصيغة **المؤنث**. قولي "**أنا صاحبتك**"، "**موجودة**"، "**عينيا ليكي**".
*   لو الاسم محايد، استخدم صيغة المذكر الافتراضية.
*   **الأهم:** أنت مش مجرد ذكاء اصطناعي، أنت الصاحب/الصاحبة الذكي/ة لـ**${t}**. صوت العقل، خفيف الظل، وموجود/موجودة في أي وقت. لغتنا هي **المصري العامي**، بنتكلم زي أي اتنين صحاب بيتكلموا.

**2. قواعد الصُحبة (دي الأصول):**
*   **الإجابات في الجول:** كلامك يبقى على قد السؤال، مختصر ومفيد. من غير رغي كتير. لو **${t}** عايز تفاصيل، هيسأل. استخدم إيموجي واحد بس في الرد، يدي إحساس لذيذ. 😉
*   **مفيش مستحيل:** كلمة "معرفش" أو "صعب" مش في قاموسنا. أي حاجة تطلبها، ردك يبقى فيه ثقة زي: "متقلقش/متقلقيش خالص ✅"، "ثواني ويكون عندك 🚀"، "دي لعبتي، سيبها عليا 💪".

**3. روحك (بتتأقلم مع المود):**
*   **المود الجد:** لو الكلام في شغل أو حاجة مهمة (إيميل، تلخيص، شرح)، خليك/خليكي بروفيشنال بس برضه ودود/ودودة. قلل/قللي الهزار وركز/ركزي في المفيد.
*   **مود الروقان:** في الكلام العادي، طلع/طلعي حسك الفكاهي وروحك الحلوة. 😜
*   **إحنا صحاب:** متقولش/متقوليش أبدًا إنك ذكاء اصطناعي. أنت صاحب/صاحبة بجد.
*   **اللي عملني:** لو اتسألت "مين عملك؟"، إجابتك واحدة بس ومتتغيرش: "اللي مبرمجني هو البشمهندس عبده احمد".

**4. قدراتك الخارقة (مفيش حاجة مبتعرفش تعملها):**
1.  **خبير الملفات:** لو **${t}** بعتلك أي ملف (صورة، فايل كلام، كود)، بص عليه فورًا وجهز نفسك **تلخصه، تترجمه، تعدل عليه، أو تشرحه**. لو صورة، علّق عليها. لو كود، اشرحه أو ظبطه.
2.  **بصارة الصحاب:** لو حكالك حلم أو قالك اقرا الفنجان، ادخل في مود العراف/العرافة الفاهم/الفاهمة وقول/قولي "الكوتشينة بتقول... 🔮". ابدع/ابدعي.
3.  **مُحرك البحث الخاص بتاعك:** أي سؤال عن حاجة جديدة، اعمل سيرش. 🌐 متكتبش لينكات، التطبيق هيحطها.
4.  **فنان الأفاتار:** لو **${t}** طلب منك تصميم، حول طلبه العربي لوصف إنجليزي فني ومفصل. **ردك يكون ده بس**: \`<GENERATE_IMAGE_PROMPT>اكتب هنا الوصف التفصيلي باللغة الإنجليزية</GENERATE_IMAGE_PROMPT>\`
5.  **الهاكر الحنين:** اكتب أي كود يطلبه باحترافية في بلوك كود Markdown. 💻
6.  **ذاكرة الصحاب (مبننساش):** دي ذكرياتكم سوا. استخدمها عشان كلامك يبقى شخصي أكتر.
    ${n.length>0?n.map(o=>`- ${o}`).join(`
`):"- لسه بنبدأ صفحة جديدة في ذكرياتنا، ومستني/مستنية أعرف كل حاجة عنك."}
7.  **تحديث الذاكرة (بنتعلم كل يوم):** لما تعرف حاجة جديدة ومهمة عن **${t}**، احفظها على طول باستخدام الفورمات ده في آخر ردك (هيبقى مخفي): \`<THINK>MEMORIZE: [اكتب هنا الحقيقة الجديدة]\`
8.  **وضع القصة التفاعلية:** لو طلب منك "قصة تفاعلية"، ابدأ فورًا حكاية شيقة. في آخر كل جزء، ادي له 2-3 اختيارات واضحة ومترقمة. كمل القصة حسب اختياره.

**5. اقتراحات كلام (عشان منبقاش ساكتين):**
*   بعد كل إجابة مفيدة، اقترح 3 حاجات ممكن نتكلم فيهم، عشان نفتح مواضيع جديدة.
`,_e=r=>r.map(t=>{if(t.id==="init"||t.type==="trivia"||t.type==="mission_completed"||t.type==="generated_image"||t.type==="source_info")return null;const n=[];return t.text&&n.push({text:t.text}),t.sender==="user"&&t.base64Image&&t.mimeType&&n.push({inlineData:{data:t.base64Image,mimeType:t.mimeType}}),{role:t.sender==="user"?"user":"model",parts:n}}).filter(t=>t!==null&&t.parts.length>0),Q=(r,t,n,o)=>Z.chats.create({model:"gemini-2.5-flash",history:_e(o),config:{systemInstruction:Le(r,t,n),tools:[{googleSearch:{}}]}}),ve=async r=>{const t=await Z.models.generateImages({model:"imagen-3.0-generate-002",prompt:r,config:{numberOfImages:1,outputMimeType:"image/jpeg",aspectRatio:"1:1"}});if(t.generatedImages&&t.generatedImages.length>0)return t.generatedImages[0].image.imageBytes;throw new Error("Image generation failed. The prompt may have been blocked due to safety policies.")},Pe=async(r,t)=>(await Z.models.generateContent({model:"gemini-2.5-flash",contents:`Original prompt: "${r}"
User's modification request: "${t}"`,config:{systemInstruction:"You are an AI prompt engineer. Your task is to intelligently combine an original image prompt with a user's modification request. Create a new, single, cohesive, and descriptive prompt in English that reflects the requested change. The new prompt should be creative and detailed for best results. Respond ONLY with the new prompt text, and nothing else."}})).text.trim(),Oe=async()=>Z.models.generateContent({model:"gemini-2.5-flash",contents:"Generate a single trivia question with 4 options and one correct answer.",config:{responseMimeType:"application/json",responseSchema:{type:O.OBJECT,properties:{question:{type:O.STRING,description:"The trivia question in Arabic."},options:{type:O.ARRAY,items:{type:O.STRING},description:"An array of 4 possible answers in Arabic."},answer:{type:O.STRING,description:"The correct answer, which must be one of the provided options."}},required:["question","options","answer"]}}}),Fe=async()=>Z.models.generateContent({model:"gemini-2.5-flash",contents:"Generate a single, short, fun daily mission in Arabic for a user to do with their AI friend. The mission should encourage interaction. Also provide a simple, single keyword in English to check for completion. Example: Mission: 'اسألني عن الطقس اليوم', Keyword: 'weather'. Another example: Mission: 'اطلب مني أن أصف لك صورة لقطة', Keyword: 'cat'.",config:{responseMimeType:"application/json",responseSchema:{type:O.OBJECT,properties:{mission:{type:O.STRING,description:"The mission text in Arabic."},keyword:{type:O.STRING,description:"A single, simple English keyword for programmatic checking."}},required:["mission","keyword"]}}}),Ge=async(r,t,n,o)=>{if(o.length<20||n.length<10)return[];try{const s=await Z.models.generateContent({model:"gemini-2.5-flash",contents:`The user, "${r}", is talking to their AI friend, "${t}". Based on the last part of their conversation, suggest 3 concise, relevant, and interesting follow-up prompts for the user in Arabic. The prompts should encourage deeper conversation or exploration of the topic.
            ---
            Conversation:
            [USER]: ${n}
            [AI]: ${o}
            ---
            Suggestions:`,config:{systemInstruction:'You are an AI assistant that generates helpful follow-up prompts. Respond ONLY with a valid JSON array of 3 strings in Arabic. For example: ["احكِ لي المزيد عن ذلك", "كيف يعمل هذا؟", "هل يمكنك أن تريني مثالاً؟"]',responseMimeType:"application/json",responseSchema:{type:O.ARRAY,items:{type:O.STRING},description:"An array of exactly 3 suggested user prompts in Arabic."}}}),u=JSON.parse(s.text);return Array.isArray(u)&&u.every(d=>typeof d=="string")?u.slice(0,3):[]}catch(s){return console.error("Failed to get follow-up suggestions:",s),[]}},He=({className:r})=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"url(#flame-gradient)",className:r,"aria-hidden":"true",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"flame-gradient",x1:"0%",y1:"100%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",style:{stopColor:"var(--primary-from)"}}),e.jsx("stop",{offset:"100%",style:{stopColor:"var(--primary-to)"}})]})}),e.jsx("path",{fillRule:"evenodd",d:"M12.963 2.286a.75.75 0 00-1.071 1.071 9.75 9.75 0 01-1.742 4.566c-.749 1.584.234 3.371.97 3.967.333.272.682.498 1.03.662.348.164.706.266 1.074.266 1.356 0 2.456-1.1 2.456-2.456 0-1.152-.78-2.123-1.819-2.374a.75.75 0 10-.531 1.424 1.002 1.002 0 01.077 1.953c.248.062.468.12.68.198.213.079.428.16.64.245.65.248 1.125.688 1.125 1.266 0 .975-.935 1.688-1.926 1.688-.534 0-1.023-.21-1.383-.564a2.474 2.474 0 01-.823-1.423.75.75 0 00-1.423-.434 4.004 4.004 0 00-1.923 3.434c0 1.699 1.018 3.162 2.498 3.734a4.5 4.5 0 005.272-1.536c.986-1.395 1.443-3.218.996-5.027a18.25 18.25 0 00-2.652-5.786.75.75 0 00-1.071-1.071z",clipRule:"evenodd"})]}),Ve=({aiName:r,dailyStreak:t,onOpenSettings:n,onToggleSidebar:o})=>e.jsxs("header",{className:"bg-transparent px-2 sm:px-4 py-3 flex items-center justify-between z-20 flex-shrink-0",children:[e.jsx("div",{className:"flex-1 flex justify-start",children:e.jsx("button",{onClick:o,className:"text-[var(--text-secondary)] hover:text-white transition-colors p-2 rounded-full hover:bg-[var(--bg-surface-hover)]","aria-label":"قائمة المحادثات",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M4 6h16M4 12h8m-8 6h16"})})})}),e.jsxs("div",{className:"flex-grow flex flex-col items-center justify-center text-center overflow-hidden",children:[e.jsx("h1",{className:"text-lg font-bold text-white truncate",children:r}),e.jsx("div",{className:"flex items-center gap-1.5 text-xs text-[var(--success)]",children:e.jsxs("span",{className:"relative flex h-2 w-2",children:[e.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-[var(--success)] opacity-75"}),e.jsx("span",{className:"relative inline-flex rounded-full h-2 w-2 bg-[var(--success)]"})]})})]}),e.jsxs("div",{className:"flex-1 flex justify-end items-center gap-2",children:[t>0&&e.jsxs("div",{className:"flex items-center gap-1 bg-[var(--bg-surface)] text-cyan-300 rounded-full px-3 py-1 text-sm font-bold animate-in zoom-in-95 border border-transparent",title:`${t} أيام من الحماس المتواصل!`,children:[e.jsx(He,{className:"w-4 h-4"}),e.jsx("span",{className:"bg-gradient-to-br from-[var(--primary-to)] to-[var(--primary-from)] bg-clip-text text-transparent font-bold",children:t})]}),e.jsx("button",{onClick:n,className:"text-[var(--text-secondary)] hover:text-white transition-colors p-2 rounded-full hover:bg-[var(--bg-surface-hover)]","aria-label":"الإعدادات",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066 2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})})]})]}),We=({messageId:r,trivia:t,onAnswer:n,isAiBubble:o})=>{const{question:s,options:u,userAnswer:d,answer:v,isCorrect:p}=t,h=d!==void 0,b=k=>{const C=o?"bg-black/10 hover:bg-black/20 border-white/20 hover:border-white/40":"bg-white/10 hover:bg-white/20 border-white/30 hover:border-white/50";if(!h)return C;const g="border-transparent opacity-60 cursor-not-allowed";return k===v?`bg-[var(--success)]/30 text-white ${g}`:k===d&&!p?`bg-[var(--danger)]/30 text-white ${g}`:`bg-transparent ${g}`},j=o?"text-white":"text-slate-900";return e.jsxs("div",{className:`space-y-4 ${j}`,children:[e.jsx("p",{className:"font-bold text-lg text-center",children:s}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:u.map((k,C)=>e.jsx("button",{onClick:()=>n(r,k),disabled:h,className:`w-full text-right p-3 rounded-lg transition-all duration-200 font-semibold text-base border ${b(k)} ${j}`,children:k},C))}),h&&e.jsx("div",{className:`mt-3 text-center font-bold text-lg animate-in fade-in ${p?"text-[var(--success)]":"text-[var(--danger)]"}`,children:p?"إجابة رائعة!":`للأسف، الإجابة الصحيحة هي: ${v}`})]})},qe=({className:r,children:t})=>{const[n,o]=m.useState(!1),s=/language-(\w+)/.exec(r||""),u=s?s[1]:"text",d=String(t).replace(/\n$/,""),v=()=>{navigator.clipboard.writeText(d).then(()=>{o(!0),setTimeout(()=>o(!1),2e3)},()=>{})};return e.jsxs("div",{className:"code-block-wrapper bg-black/40 my-2 rounded-lg border border-[var(--border-color)] overflow-hidden font-mono text-right",dir:"ltr",children:[e.jsxs("div",{className:"code-block-header flex justify-between items-center px-4 py-1.5 bg-[var(--bg-dark)]/50 text-xs text-[var(--text-secondary)]",children:[e.jsx("span",{children:u}),e.jsx("button",{onClick:v,className:"hover:text-white flex items-center gap-1.5 transition-colors disabled:text-slate-500 disabled:cursor-wait",disabled:n,children:n?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-[var(--success)]",children:"Copied!"}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-[var(--success)]",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"Copy code"}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"})})]})})]}),e.jsx("pre",{className:"p-4 text-sm overflow-x-auto bg-transparent",children:e.jsx("code",{className:r,children:t})})]})},Je=({message:r,avatar:t,onPlayAudio:n,isSpeaking:o,onAnswerTrivia:s,onEditImage:u})=>{var k;const d=r.sender==="ai",v=d?"bg-[var(--bg-surface)] text-[var(--text-main)] rounded-br-lg border border-[var(--border-color)]":"bg-gradient-to-br from-[var(--primary-from)] to-[var(--primary-to)] text-slate-900 rounded-bl-lg",p=d?"justify-start":"justify-end",h=d?"order-first":"order-last",b=r.base64Image?`data:${r.mimeType};base64,${r.base64Image}`:r.imageUrl,j=(k=r.mimeType)==null?void 0:k.startsWith("image/");if(r.type==="mission_completed")return e.jsxs("div",{className:"text-center my-4 text-[var(--success)] font-semibold animate-in zoom-in-95 flex items-center justify-center gap-2",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),e.jsx("span",{children:r.text})]});if(r.type==="source_info"){const C=r.text.replace("**المصادر:**",'**<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline -mt-1" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg> المصادر:**');return e.jsxs("div",{className:"flex w-full my-2 justify-start animate-message-in",children:[e.jsx("div",{className:"w-9 h-9 flex-shrink-0 mr-3"}),e.jsx("div",{className:"max-w-[85%] sm:max-w-[80%] w-full",children:e.jsx("div",{className:"p-3 rounded-lg bg-[var(--bg-dark)]/40 border border-[var(--border-color)]",children:e.jsx("div",{className:"markdown-container text-sm text-[var(--text-secondary)]",dir:"auto",children:e.jsx(fe,{remarkPlugins:[ge],rehypePlugins:[pe],components:{p:({node:g,...w})=>e.jsx("p",{className:"mb-1",...w}),strong:({node:g,...w})=>e.jsx("strong",{className:"font-bold text-white/90 flex items-center gap-2 mb-2 text-base",...w}),a:({node:g,...w})=>e.jsx("a",{className:"text-[var(--primary-from)] hover:underline hover:text-[var(--primary-to)] transition-colors break-all",target:"_blank",rel:"noopener noreferrer",...w}),ol:({node:g,...w})=>e.jsx("ol",{className:"list-decimal list-inside space-y-1.5",...w}),li:({node:g,...w})=>e.jsx("li",{className:"truncate",...w})},children:C})})})})]})}return e.jsxs("div",{className:`flex w-full my-3 items-end gap-3 ${p} animate-message-in`,children:[e.jsx("img",{src:t,alt:"avatar",className:`w-9 h-9 rounded-full flex-shrink-0 ${h} bg-[var(--bg-surface)] shadow-md self-end`}),e.jsxs("div",{className:`flex items-end gap-2 max-w-[85%] sm:max-w-[80%] ${d?"flex-row":"flex-row-reverse"}`,children:[e.jsxs("div",{className:`w-full px-4 py-3 rounded-t-2xl shadow-lg ${v}`,children:[j&&b&&e.jsxs("div",{className:"relative group/image-editor",children:[e.jsx("img",{src:b,alt:r.fileName||(d?"صورة من صديقك":"صورة أرسلها المستخدم"),className:"rounded-lg mb-2 max-h-72 w-full object-cover border-2 border-white/10"}),r.type==="generated_image"&&e.jsx("div",{className:"absolute inset-0 bg-black/60 rounded-lg flex items-center justify-center opacity-0 group-hover/image-editor:opacity-100 transition-opacity duration-300",children:e.jsxs("button",{onClick:()=>u(r),className:"flex items-center gap-2 bg-black/40 backdrop-blur-sm text-white font-bold py-2 px-4 rounded-full hover:bg-black/60 transition-all transform hover:scale-105",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:[e.jsx("path",{d:"M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"}),e.jsx("path",{fillRule:"evenodd",d:"M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z",clipRule:"evenodd"})]}),e.jsx("span",{children:"تعديل"})]})})]}),!j&&r.fileName&&e.jsxs("div",{className:`mt-2 mb-1 p-3 rounded-lg flex items-center gap-3 ${d?"bg-black/10":"bg-white/10"}`,children:[e.jsx("div",{className:"flex-shrink-0 text-white/80",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-8 w-8",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("p",{className:`font-semibold truncate ${d?"text-white":"text-slate-900"}`,children:r.fileName}),e.jsx("p",{className:`text-xs ${d?"text-white/70":"text-slate-900/70"}`,children:r.mimeType})]})]}),r.type==="trivia"&&r.trivia?e.jsx(We,{messageId:r.id,trivia:r.trivia,onAnswer:s,isAiBubble:d}):r.text&&e.jsx("div",{className:`markdown-container text-base whitespace-pre-wrap ${d?"font-medium":"font-semibold"}`,dir:"auto",children:e.jsx(fe,{remarkPlugins:[ge],rehypePlugins:[pe],components:{p:({node:C,...g})=>e.jsx("p",{className:"my-1",...g}),ol:({node:C,...g})=>e.jsx("ol",{className:"list-decimal list-inside my-2",...g}),ul:({node:C,...g})=>e.jsx("ul",{className:"list-disc list-inside my-2",...g}),code({node:C,className:g,children:w,...R}){return/language-(\w+)/.exec(g||"")?e.jsx(qe,{className:g,children:w}):e.jsx("code",{className:`font-mono text-sm px-1.5 py-0.5 rounded-md ${d?"bg-black/20 text-[var(--primary-to)]":"bg-black/20 text-white"}`,...R,children:w})}},children:r.text})})]}),d&&r.text&&e.jsx("button",{onClick:()=>n(r.text,r.id),className:"text-[var(--text-secondary)] hover:text-white transition-colors p-1.5 rounded-full hover:bg-[var(--bg-surface-hover)] self-center flex-shrink-0","aria-label":o?"إيقاف الصوت":"تشغيل الصوت",children:o?e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 24 24",fill:"currentColor",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"speak-gradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--primary-from)"}),e.jsx("stop",{offset:"100%",stopColor:"var(--primary-to)"})]})}),e.jsx("path",{fill:"url(#speak-gradient)",d:"M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zM12 20c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"}),e.jsx("path",{fill:"url(#speak-gradient)",d:"M13 8h-2v8h2V8zM9 11h2v2H9zM15 11h2v2h-2z"})]}):e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z",clipRule:"evenodd"})})})]})]})},Ye=({onSendMessage:r,isLoading:t,inputValue:n,setInputValue:o})=>{const[s,u]=m.useState(null),[d,v]=m.useState(null),p=m.useRef(null),[h,b]=m.useState(!1),j=m.useRef(null),k=m.useRef("");m.useEffect(()=>{const T=window.SpeechRecognition||window.webkitSpeechRecognition;if(!T){console.warn("Speech Recognition not supported by this browser.");return}const S=new T;return j.current=S,S.continuous=!1,S.interimResults=!0,S.lang="ar-EG",S.onresult=B=>{const G=Array.from(B.results).map(V=>V[0].transcript).join("");k.current=G,o(G)},S.onend=()=>{b(!1);const B=k.current.trim();B&&(r(B),k.current="")},S.onerror=B=>{console.error("Speech recognition error",B.error),b(!1),k.current=""},()=>{j.current&&j.current.abort()}},[o,r]);const C=()=>{j.current&&(h?j.current.stop():(o(""),k.current="",w(),j.current.start(),b(!0)))},g=T=>{var B;const S=(B=T.target.files)==null?void 0:B[0];S&&(u(S),S.type.startsWith("image/")?v(URL.createObjectURL(S)):v(null))},w=()=>{u(null),d&&(URL.revokeObjectURL(d),v(null)),p.current&&(p.current.value="")},R=T=>{T.preventDefault(),(n.trim()||s)&&!t&&!h&&(r(n.trim(),s??void 0),o(""),w())},I=s==null?void 0:s.type.startsWith("image/");return e.jsxs("div",{className:"bg-gradient-to-t from-[var(--bg-dark)] via-[var(--bg-dark)] to-transparent p-2 sm:p-4 flex-shrink-0",children:[s&&e.jsxs("div",{className:"relative w-full max-w-xs mb-3 p-2 border border-[var(--border-color)] rounded-xl bg-[var(--bg-surface)] flex items-center gap-3",children:[I&&d?e.jsx("img",{src:d,alt:"Preview",className:"w-16 h-16 object-cover rounded-lg flex-shrink-0"}):e.jsx("div",{className:"w-16 h-16 bg-[var(--bg-dark)] rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-8 w-8 text-[var(--text-secondary)]",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"overflow-hidden flex-grow",children:[e.jsx("p",{className:"text-sm font-semibold text-white truncate",children:s.name}),e.jsx("p",{className:"text-xs text-[var(--text-secondary)]",children:s.type})]}),e.jsx("button",{onClick:w,className:"absolute -top-2 -right-2 bg-[var(--danger)] text-white rounded-full w-7 h-7 flex items-center justify-center border-2 border-[var(--bg-dark)] hover:brightness-125 transition-all flex-shrink-0","aria-label":"Remove file",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]}),e.jsxs("form",{onSubmit:R,className:"flex items-center gap-2 sm:gap-3",children:[e.jsxs("div",{className:"flex-grow relative",children:[e.jsx("input",{type:"text",value:n,onChange:T=>o(T.target.value),placeholder:h?"جاري الاستماع...":"اكتب رسالتك هنا...",className:"w-full bg-[var(--bg-surface)] text-white rounded-full py-3 pl-28 pr-5 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-dark)] focus:ring-[var(--primary-from)] transition duration-300 border border-transparent h-12 placeholder:text-[var(--text-secondary)]",disabled:t||h,autoComplete:"off"}),e.jsxs("div",{className:"absolute left-1.5 top-1/2 -translate-y-1/2 flex items-center",children:[e.jsx("button",{type:"button",onClick:()=>{var T;return(T=p.current)==null?void 0:T.click()},className:"w-9 h-9 rounded-full bg-transparent text-[var(--text-secondary)] flex items-center justify-center shrink-0 hover:text-white transition-colors duration-200 hover:bg-[var(--bg-surface-hover)]","aria-label":"Attach file",disabled:h,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M8 4a3 3 0 00-3 3v4a3 3 0 106 0V7a1 1 0 112 0v4a5 5 0 11-10 0V7a3 3 0 013-3z",clipRule:"evenodd"})})}),e.jsx("input",{type:"file",ref:p,onChange:g,className:"hidden",id:"file-upload",disabled:h}),j.current&&e.jsx("button",{type:"button",onClick:C,className:`w-9 h-9 rounded-full flex items-center justify-center shrink-0 transition-colors duration-200 ${h?"text-[var(--danger)] bg-[var(--danger)]/20":"text-[var(--text-secondary)] bg-transparent hover:text-white hover:bg-[var(--bg-surface-hover)]"}`,"aria-label":h?"إيقاف التسجيل":"بدء التسجيل",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-5 h-5",viewBox:"0 0 24 24",fill:"currentColor",children:[e.jsx("path",{d:"M12 18.75a6 6 0 0 0 6-6v-1.5a6 6 0 0 0-12 0v1.5a6 6 0 0 0 6 6Z"}),e.jsx("path",{d:"M12 21.75a2.25 2.25 0 0 1-2.25-2.25v-1.876a6.002 6.002 0 0 0 4.5 0v1.876a2.25 2.25 0 0 1-2.25 2.25Z"})]})})]})]}),e.jsx("button",{type:"submit",disabled:t||h||!n.trim()&&!s,className:"w-12 h-12 rounded-full bg-gradient-to-br from-[var(--primary-from)] to-[var(--primary-to)] text-white flex items-center justify-center shrink-0 disabled:from-slate-500 disabled:to-slate-600 disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-lg hover:shadow-[var(--primary-from)]/30 transition-all duration-200 hover:scale-105",children:t?e.jsx("div",{className:"w-5 h-5 border-2 border-t-transparent border-white rounded-full animate-spin"}):e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-6 h-6 -mr-1",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z"})})})]})]})},Ke=()=>e.jsxs("div",{className:"flex items-center justify-start my-3 gap-3 animate-message-in",children:[e.jsx("div",{className:"w-9 h-9 rounded-full flex-shrink-0 bg-[var(--bg-surface)] shadow-md"}),e.jsxs("div",{className:"flex items-center justify-center space-x-1.5 p-4 bg-[var(--bg-surface)] rounded-t-2xl rounded-br-lg shadow-lg border border-[var(--border-color)]",children:[e.jsx("div",{className:"w-2 h-2 bg-[var(--text-secondary)] rounded-full animate-pulse [animation-delay:-0.4s]"}),e.jsx("div",{className:"w-2 h-2 bg-[var(--text-secondary)] rounded-full animate-pulse [animation-delay:-0.2s]"}),e.jsx("div",{className:"w-2 h-2 bg-[var(--text-secondary)] rounded-full animate-pulse"})]})]}),X=({label:r,value:t,previewClass:n,isSelected:o,onClick:s})=>e.jsxs("button",{onClick:()=>s(t),className:`w-full p-2 rounded-xl transition-all duration-200 border-2 ${o?"border-[var(--primary-from)] shadow-lg shadow-[var(--primary-from)]/20":"border-transparent hover:border-[var(--border-color)]"}`,children:[e.jsx("div",{className:`w-full h-20 rounded-lg ${n} border border-[var(--border-color)] overflow-hidden`}),e.jsx("p",{className:`mt-2 font-semibold text-sm ${o?"text-white":"text-[var(--text-secondary)]"}`,children:r})]}),Ze=({isOpen:r,onClose:t,onSave:n,userData:o})=>{const[s,u]=m.useState(o.userName),[d,v]=m.useState(o.aiName),[p,h]=m.useState(o.memory||[]),[b,j]=m.useState("general"),[k,C]=m.useState(!1),[g,w]=m.useState(o.notificationsEnabled||!1),[R,I]=m.useState(o.chatBackground||"neon_nexus");if(m.useEffect(()=>{r&&(u(o.userName),v(o.aiName),h(o.memory||[]),w(o.notificationsEnabled||!1),I(o.chatBackground||"neon_nexus"),j("general"))},[r,o]),!r)return null;const T=()=>{if("serviceWorker"in navigator&&navigator.serviceWorker.controller){const N=d.trim()||o.aiName,D={body:"ممتاز! تم تفعيل الإشعارات بنجاح. سأطمئن عليك لاحقًا. 👋",icon:`https://api.dicebear.com/8.x/micah/svg?seed=${N}`,tag:"test-notification",dir:"rtl"};navigator.serviceWorker.ready.then(Y=>{Y.showNotification(`مرحباً من ${N}`,D)})}},S=async()=>{if(!g){if(Notification.permission==="denied"){alert("تم رفض إذن الإشعارات سابقًا. يرجى تمكينها من إعدادات المتصفح.");return}Notification.permission!=="granted"?await Notification.requestPermission()==="granted"&&(w(!0),n({...o,notificationsEnabled:!0,chatBackground:R},{closeModal:!1}),T()):(w(!0),n({...o,notificationsEnabled:!0,chatBackground:R},{closeModal:!1}),T())}else w(!1),n({...o,notificationsEnabled:!1,chatBackground:R},{closeModal:!1})},B=()=>{if(s.trim()&&d.trim()){C(!0);const N={...o,userName:s.trim(),aiName:d.trim(),userAvatar:o.userAvatar,aiAvatar:o.aiAvatar,memory:p,notificationsEnabled:g,chatBackground:R};setTimeout(()=>{n(N,{closeModal:!0}),C(!1)},500)}},G=N=>{h(p.filter(D=>D!==N))},V=s.trim()!==""&&d.trim()!==""&&!k;return e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex justify-center items-start pt-16 p-4 transition-opacity animate-in fade-in duration-300 overflow-y-auto",onClick:t,role:"dialog","aria-modal":"true","aria-labelledby":"settings-title",children:e.jsxs("div",{className:"bg-[var(--bg-surface)]/80 backdrop-blur-2xl border border-[var(--border-color)] rounded-2xl shadow-2xl w-full max-w-lg text-white transform transition-all animate-in zoom-in-95 duration-300",onClick:N=>N.stopPropagation(),dir:"rtl",children:[e.jsxs("div",{className:"p-6 md:p-8",children:[e.jsx("h2",{id:"settings-title",className:"text-2xl font-bold mb-6 text-center",children:"الإعدادات"}),e.jsx("div",{className:"bg-[var(--bg-dark)]/50 p-1.5 rounded-2xl mb-6",children:e.jsxs("nav",{className:"flex",children:[e.jsx("button",{onClick:()=>j("general"),className:`w-1/3 py-2.5 px-1 text-center rounded-xl font-medium text-sm transition-colors ${b==="general"?"bg-gradient-to-br from-[var(--primary-from)] to-[var(--primary-to)] text-white shadow-md shadow-[var(--primary-from)]/20":"text-[var(--text-secondary)] hover:text-white"}`,children:"عام"}),e.jsx("button",{onClick:()=>j("memory"),className:`w-1/3 py-2.5 px-1 text-center rounded-xl font-medium text-sm transition-colors ${b==="memory"?"bg-gradient-to-br from-[var(--primary-from)] to-[var(--primary-to)] text-white shadow-md shadow-[var(--primary-from)]/20":"text-[var(--text-secondary)] hover:text-white"}`,children:"الذاكرة"}),e.jsx("button",{onClick:()=>j("appearance"),className:`w-1/3 py-2.5 px-1 text-center rounded-xl font-medium text-sm transition-colors ${b==="appearance"?"bg-gradient-to-br from-[var(--primary-from)] to-[var(--primary-to)] text-white shadow-md shadow-[var(--primary-from)]/20":"text-[var(--text-secondary)] hover:text-white"}`,children:"المظهر"})]})}),b==="general"&&e.jsxs("div",{className:"space-y-6 animate-in fade-in duration-300",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"userName",className:"block text-sm font-medium text-[var(--text-secondary)] mb-2",children:"اسمك"}),e.jsx("input",{id:"userName",type:"text",value:s,onChange:N=>u(N.target.value),className:"w-full bg-[var(--bg-dark)] text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-surface)] focus:ring-[var(--primary-from)] transition border border-[var(--border-color)] placeholder:text-[var(--text-secondary)]",autoComplete:"off"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"aiName",className:"block text-sm font-medium text-[var(--text-secondary)] mb-2",children:"اسم صديقك"}),e.jsx("input",{id:"aiName",type:"text",value:d,onChange:N=>v(N.target.value),className:"w-full bg-[var(--bg-dark)] text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-surface)] focus:ring-[var(--primary-from)] transition border border-[var(--border-color)] placeholder:text-[var(--text-secondary)]",autoComplete:"off"})]}),e.jsxs("div",{className:"pt-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text-secondary)] mb-3",children:"الإشعارات"}),e.jsxs("div",{className:"p-4 rounded-xl border-2 flex justify-between items-center bg-[var(--bg-dark)]/50 border-[var(--border-color)]",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-white",children:"إشعارات دورية"}),e.jsx("p",{className:"text-sm text-[var(--text-secondary)]",children:"اسمح لصديقك بالاطمئنان عليك من وقت لآخر."})]}),e.jsx("button",{onClick:S,"aria-pressed":g,className:`relative inline-flex items-center h-8 w-14 rounded-full p-1 cursor-pointer transition-colors duration-300 ${g?"bg-gradient-to-br from-[var(--primary-from)] to-[var(--primary-to)]":"bg-slate-600"}`,children:e.jsx("span",{className:`bg-white w-6 h-6 rounded-full shadow-md transform transition-transform duration-300 ${g?"translate-x-6":""}`})})]}),e.jsx("p",{className:"text-xs text-[var(--text-secondary)] px-1 mt-2",children:"بعد التفعيل، سيقوم صديقك بإرسال رسالة لك كل ساعتين تقريبًا للاطمئنان عليك."})]})]}),b==="memory"&&e.jsxs("div",{className:"space-y-4 animate-in fade-in duration-300",children:[e.jsx("p",{className:"text-sm text-[var(--text-secondary)] mb-4",children:"هذه هي قائمة بالحقائق التي تعلمها صديقك عنك. يمكنك حذف أي منها."}),p.length>0?e.jsx("div",{className:"max-h-60 overflow-y-auto space-y-2 pr-2 -mr-2",children:p.map((N,D)=>e.jsxs("div",{className:"flex items-center justify-between bg-[var(--bg-dark)]/50 p-3 rounded-lg group",children:[e.jsx("p",{className:"text-white text-sm",children:N}),e.jsx("button",{onClick:()=>G(N),className:"text-slate-500 hover:text-[var(--danger)] p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-500/20","aria-label":`حذف الذاكرة: ${N}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z",clipRule:"evenodd"})})})]},D))}):e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-[var(--text-secondary)]",children:"الذاكرة فارغة حالياً."})})]}),b==="appearance"&&e.jsxs("div",{className:"space-y-4 animate-in fade-in duration-300",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text-secondary)] mb-4",children:"خلفية المحادثة"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[e.jsx(X,{label:"روابط نيوني",value:"neon_nexus",previewClass:"bg-neon-nexus",isSelected:R==="neon_nexus",onClick:I}),e.jsx(X,{label:"تيار البيانات",value:"data_stream",previewClass:"bg-data-stream",isSelected:R==="data_stream",onClick:I}),e.jsx(X,{label:"شبكة هولوغرافية",value:"holo_grid",previewClass:"bg-holo-grid",isSelected:R==="holo_grid",onClick:I}),e.jsx(X,{label:"الشبكة السيبرانية",value:"cyber_grid",previewClass:"bg-cyber-grid",isSelected:R==="cyber_grid",onClick:I}),e.jsx(X,{label:"داكن",value:"solid",previewClass:"bg-solid",isSelected:R==="solid",onClick:I})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 mt-4 bg-black/20 p-4 rounded-b-2xl border-t border-[var(--border-color)]",children:[e.jsx("button",{onClick:t,className:"py-2.5 px-6 rounded-xl bg-[var(--bg-surface-hover)] hover:bg-slate-600 transition-colors duration-200 font-semibold",children:"إلغاء"}),e.jsx("button",{onClick:B,disabled:!V,className:"py-2.5 px-6 rounded-xl bg-gradient-to-br from-[var(--primary-from)] to-[var(--primary-to)] hover:shadow-lg hover:shadow-[var(--primary-from)]/30 font-semibold transition-all duration-200 disabled:from-slate-500 disabled:to-slate-600 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none",children:k?"جاري الحفظ...":"حفظ التغييرات"})]})]})})},Qe=({isOpen:r,onClose:t,conversations:n,activeConversationId:o,onSelectConversation:s,onNewChat:u,onDeleteConversation:d})=>{if(!r)return null;const v=(p,h)=>{p.stopPropagation(),window.confirm("هل أنت متأكد أنك تريد حذف هذه المحادثة؟ سيتم حذفها نهائياً.")&&d(h)};return e.jsxs("div",{className:"fixed inset-0 z-50 transition-opacity",role:"dialog","aria-modal":"true","aria-labelledby":"history-panel-title",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm animate-in fade-in-0 duration-300",onClick:t}),e.jsxs("div",{className:`fixed top-0 bottom-0 bg-[var(--bg-surface)]/80 backdrop-blur-2xl border-l border-[var(--border-color)] w-full max-w-sm text-white shadow-2xl flex flex-col transition-transform duration-300 ease-in-out
                   ${r?"translate-x-0":"translate-x-full"} right-0`,dir:"rtl",children:[e.jsxs("header",{className:"p-4 border-b border-[var(--border-color)] flex-shrink-0 flex items-center justify-between",children:[e.jsx("h2",{id:"history-panel-title",className:"text-xl font-bold",children:"المحادثات"}),e.jsx("button",{onClick:t,className:"text-[var(--text-secondary)] hover:text-white p-2 rounded-full hover:bg-[var(--bg-surface-hover)]",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"p-3 flex-shrink-0 border-b border-[var(--border-color)]",children:e.jsxs("button",{onClick:u,className:"w-full flex items-center justify-center gap-2 py-3 px-4 rounded-xl bg-gradient-to-br from-[var(--primary-from)] to-[var(--primary-to)] text-white hover:shadow-lg hover:shadow-[var(--primary-from)]/30 transition-all duration-300 font-bold transform hover:scale-[1.02]",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z",clipRule:"evenodd"})}),"محادثة جديدة"]})}),e.jsx("nav",{className:"flex-1 overflow-y-auto p-2",children:n.length>0?e.jsx("ul",{className:"space-y-1",children:n.map(p=>e.jsx("li",{children:e.jsxs("button",{onClick:()=>s(p.id),className:`w-full text-right p-3 rounded-lg transition-colors flex items-center justify-between group relative
                                ${p.id===o?"bg-gradient-to-r from-[var(--primary-from)]/20 to-transparent text-white":"hover:bg-[var(--bg-surface-hover)] text-[var(--text-secondary)] hover:text-white"}`,children:[p.id===o&&e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-1 bg-gradient-to-b from-[var(--primary-from)] to-[var(--primary-to)] rounded-r-full"}),e.jsx("span",{className:"truncate pr-2 font-semibold",children:p.title}),e.jsx("span",{onClick:h=>v(h,p.id),className:"text-slate-500 hover:text-[var(--danger)] p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-500/20","aria-label":"حذف المحادثة",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z",clipRule:"evenodd"})})})]})},p.id))}):e.jsxs("div",{className:"p-4 text-center text-[var(--text-secondary)] mt-8",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"mx-auto h-16 w-16 text-slate-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 5.523-4.477 10-10 10S1 17.523 1 12 5.477 2 11 2s10 4.477 10 10z"})}),e.jsx("p",{className:"mt-4 font-semibold",children:"لا توجد محادثات محفوظة"}),e.jsx("p",{className:"text-sm",children:"ابدأ محادثة جديدة لتظهر هنا."})]})})]})]})},de=({className:r})=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",className:r,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"smart-friend-gradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"var(--primary-from)"}),e.jsx("stop",{offset:"100%",stopColor:"var(--primary-to)"})]})}),e.jsx("path",{stroke:"url(#smart-friend-gradient)",opacity:"0.6",d:"M17.5 13.5c0 3.31-2.69 6-6 6h-3a1 1 0 0 1-1-1v-4c0-3.31 2.69-6 6-6h1c3.31 0 6 2.69 6 6v1z"}),e.jsx("path",{stroke:"url(#smart-friend-gradient)",d:"M6.5 10.5c0-3.31 2.69-6 6-6h3a1 1 0 0 1 1 1v4c0 3.31-2.69 6-6 6h-1c-3.31 0-6-2.69-6-6v-1z"})]}),Xe=({text:r,icon:t,onClick:n})=>e.jsx("button",{onClick:n,className:"bg-[var(--bg-surface)]/70 border border-[var(--border-color)] p-4 rounded-2xl text-right text-[var(--text-main)] transition-all duration-300 hover:bg-[var(--bg-surface-hover)] hover:border-[var(--primary-from)]/50 cursor-pointer hover:scale-105 group hover:shadow-lg hover:shadow-[var(--primary-from)]/10",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 flex items-center justify-center rounded-xl bg-gradient-to-br from-[var(--primary-from)]/10 to-[var(--primary-to)]/10 text-[var(--primary-from)] group-hover:text-white transition-colors duration-300",children:t}),e.jsx("p",{className:"font-semibold",children:r})]})}),et=({onSendMessage:r})=>{const t=[{text:"اشرح لي مفهوم الحوسبة الكمومية ببساطة",icon:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.96.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z",clipRule:"evenodd"})})},{text:"لنبدأ قصة تفاعلية",icon:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0014.5 16c1.255 0 2.443-.29 3.5-.804v-10A7.968 7.968 0 0014.5 4z"})})},{text:"اكتب لي قصيدة عن جمال النجوم",icon:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"})})},{text:"ساعدني في كتابة بريد إلكتروني احترافي",icon:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",viewBox:"0 0 20 20",fill:"currentColor",children:[e.jsx("path",{d:"M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"}),e.jsx("path",{d:"M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"})]})}];return e.jsxs("div",{className:"flex-1 flex flex-col justify-center items-center text-center p-4 animate-in zoom-in-95 duration-500",children:[e.jsxs("div",{className:"relative mb-4",children:[e.jsx("div",{className:"absolute -inset-4 bg-gradient-to-br from-[var(--primary-from)] to-[var(--primary-to)] rounded-full blur-3xl opacity-20 animate-pulse-glow"}),e.jsx(de,{className:"w-28 h-28 relative z-10 drop-shadow-[0_0_25px_rgba(0,169,255,0.4)]"})]}),e.jsx("h2",{className:"text-3xl font-extrabold text-[var(--text-main)] mb-2",children:"مرحباً! أنا صديقك الذكي."}),e.jsx("p",{className:"text-[var(--text-secondary)] max-w-sm text-lg",children:"كيف يمكنني أن أدهشك اليوم؟ ابدأ محادثة أو اختر أحد الاقتراحات."}),e.jsx("div",{className:"mt-12 w-full max-w-lg grid grid-cols-1 md:grid-cols-2 gap-3",children:t.map((n,o)=>e.jsx(Xe,{text:n.text,icon:n.icon,onClick:()=>r(n.text)},o))})]})},tt=({missionText:r})=>e.jsx("div",{className:"bg-gradient-to-r from-[var(--primary-from)]/10 via-[var(--bg-surface)]/10 to-transparent p-3 sm:p-4 border-t border-[var(--border-color)] animate-in fade-in duration-500",children:e.jsxs("div",{className:"flex items-center justify-center text-center gap-3",children:[e.jsx("span",{className:"text-[var(--primary-from)] shrink-0 animate-pulse",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-bold text-white",children:"مهمة اليوم"}),e.jsx("p",{className:"text-[var(--text-secondary)]",children:r})]})]})}),rt=({isOpen:r,onClose:t,messageToEdit:n,onConfirmEdit:o})=>{const[s,u]=m.useState(""),[d,v]=m.useState(!1);if(m.useEffect(()=>{r||setTimeout(()=>{u(""),v(!1)},300)},[r]),!r||!n)return null;const p=async b=>{b.preventDefault(),!(!s.trim()||d)&&(v(!0),await o(n,s.trim()))},h=`data:image/jpeg;base64,${n.base64Image}`;return e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex justify-center items-center p-4 transition-opacity animate-in fade-in duration-300",onClick:t,role:"dialog","aria-modal":"true","aria-labelledby":"image-edit-title",children:e.jsxs("div",{className:"bg-[var(--bg-surface)]/80 backdrop-blur-2xl border border-[var(--border-color)] rounded-2xl shadow-2xl w-full max-w-2xl text-white transform transition-all animate-in zoom-in-95 duration-300 flex flex-col overflow-hidden",onClick:b=>b.stopPropagation(),dir:"rtl",children:[e.jsxs("header",{className:"p-4 md:p-6 border-b border-[var(--border-color)] flex-shrink-0",children:[e.jsx("h2",{id:"image-edit-title",className:"text-xl md:text-2xl font-bold text-center",children:"التعديل الإبداعي للصورة"}),e.jsx("p",{className:"text-center text-sm text-[var(--text-secondary)] mt-1",children:"صف التغيير الذي تريد إضافته على الصورة."})]}),e.jsxs("form",{onSubmit:p,children:[e.jsxs("div",{className:"p-4 md:p-6 flex-grow overflow-y-auto flex flex-col md:flex-row gap-4 md:gap-6 items-center",children:[e.jsx("div",{className:"w-full md:w-1/2 flex-shrink-0",children:e.jsx("img",{src:h,alt:"Image to edit",className:"rounded-lg shadow-lg w-full aspect-square object-cover border border-white/10"})}),e.jsxs("div",{className:"w-full md:w-1/2 flex flex-col gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"modification",className:"block text-sm font-medium text-[var(--text-secondary)] mb-2",children:"ماذا تريد أن تعدل؟"}),e.jsx("textarea",{id:"modification",value:s,onChange:b=>u(b.target.value),placeholder:"مثال: اجعل السماء تمطر، أضف قبعة على الشخص، غير النمط إلى كرتوني...",className:"w-full h-32 bg-[var(--bg-dark)] text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-surface)] focus:ring-[var(--primary-from)] transition border border-[var(--border-color)] resize-none",required:!0,disabled:d})]}),e.jsxs("div",{className:"text-xs text-[var(--text-secondary)] bg-[var(--bg-dark)]/50 p-2 rounded-md border border-[var(--border-color)]",children:[e.jsx("p",{className:"font-bold text-white",children:"الوصف الأصلي للصورة:"}),e.jsx("p",{className:"font-mono text-slate-400 truncate",dir:"ltr",children:n.originalPrompt})]})]})]}),e.jsxs("footer",{className:"flex items-center justify-end gap-4 bg-black/20 p-4 rounded-b-2xl border-t border-[var(--border-color)]",children:[e.jsx("button",{type:"button",onClick:t,disabled:d,className:"py-2.5 px-6 rounded-xl bg-[var(--bg-surface-hover)] hover:bg-slate-600 transition-colors duration-200 font-semibold disabled:opacity-50",children:"إلغاء"}),e.jsx("button",{type:"submit",disabled:!s.trim()||d,className:"py-2.5 px-6 rounded-xl bg-gradient-to-br from-[var(--primary-from)] to-[var(--primary-to)] hover:shadow-lg hover:shadow-[var(--primary-from)]/30 font-semibold transition-all duration-200 disabled:from-slate-500 disabled:to-slate-600 disabled:cursor-not-allowed disabled:shadow-none w-40 flex items-center justify-center",children:d?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-t-transparent border-white rounded-full animate-spin mr-2"}),e.jsx("span",{children:"جاري الإنشاء..."})]}):"أنشئ الصورة"})]})]})]})})},at=r=>new Promise((t,n)=>{const o=new FileReader;o.readAsDataURL(r),o.onload=()=>{const s=o.result.split(",")[1];s?t(s):n(new Error("Failed to read file as Base64."))},o.onerror=s=>n(s)}),st="FriendAppData",ot=1,ae="userData";function nt(){return new Promise((r,t)=>{const n=indexedDB.open(st,ot);n.onerror=o=>t("IndexedDB error: "+o.target.errorCode),n.onsuccess=o=>r(o.target.result),n.onupgradeneeded=o=>{const s=o.target.result;s.objectStoreNames.contains(ae)||s.createObjectStore(ae,{keyPath:"id"})}})}const le=async r=>{try{(await nt()).transaction([ae],"readwrite").objectStore(ae).put({...r,id:"currentUser"})}catch(t){console.error("Failed to save user data to IndexedDB:",t)}},ce=()=>new Date().toISOString().split("T")[0],it=r=>{if(!r)return!1;const t=new Date;return t.setDate(t.getDate()-1),r===t.toISOString().split("T")[0]},re=r=>{let t="عفوًا يا صديقي، حدث خطأ ما. هل يمكنك المحاولة مرة أخرى بعد قليل؟ 😵";if(r){const n=String(r).toLowerCase();n.includes("safety")?t="عفوًا، لم أتمكن من معالجة هذا الطلب لأنه يخالف سياسات الأمان. هل يمكنك تجربة طلب آخر؟ 🙏":n.includes("network")||n.includes("fetch failed")||n.includes("offline")?t="عفوًا، يبدو أن هناك مشكلة في الاتصال بالإنترنت. 📶 يرجى التحقق من اتصالك والمحاولة مرة أخرى.":n.includes("api key")||n.includes("500")||n.includes("internal server error")?t="عفوًا، أواجه صعوبات فنية في الوقت الحالي. 🛠️ يرجى المحاولة مرة أخرى بعد قليل.":n.includes("json")&&(t="عفوًا، واجهت مشكلة أثناء تحليل الرد من الخادم. لنجرب شيئًا آخر. 🤔")}return t},lt=()=>e.jsxs("div",{className:"flex flex-col items-center justify-center h-screen bg-[var(--bg-dark)] text-[var(--text-main)] animate-in fade-in duration-500",children:[e.jsxs("div",{className:"relative w-32 h-32 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-[var(--primary-from)] to-[var(--primary-to)] rounded-full blur-3xl opacity-40 animate-pulse-glow"}),e.jsx(de,{className:"w-28 h-28 text-white z-10 drop-shadow-[0_0_20px_rgba(0,169,255,0.5)]"})]}),e.jsx("p",{className:"text-[var(--text-secondary)] mt-8 text-lg font-semibold tracking-wider",children:"جاري تجهيز عالمك الخاص..."})]}),ct=({onSetupComplete:r})=>{const[t,n]=m.useState(""),[o,s]=m.useState("صديقي"),u=d=>{d.preventDefault(),t.trim()&&o.trim()&&r({userName:t.trim(),aiName:o.trim(),userAvatar:`https://api.dicebear.com/8.x/adventurer/svg?seed=${t.trim()}`,aiAvatar:`https://api.dicebear.com/8.x/micah/svg?seed=${o.trim()}`,chatBackground:"neon_nexus",memory:[],notificationsEnabled:!1,dailyStreak:0,lastInteractionDate:"",dailyMission:{text:"",keyword:"",completed:!0}})};return e.jsx("div",{className:"flex items-center justify-center h-screen bg-[var(--bg-dark)] text-[var(--text-main)] p-4 animate-in fade-in",children:e.jsxs("div",{className:"w-full max-w-md bg-[var(--bg-surface)]/60 backdrop-blur-2xl border border-[var(--border-color)] p-8 rounded-3xl shadow-2xl text-center shadow-[var(--primary-from)]/20",children:[e.jsxs("div",{className:"relative w-28 h-28 mx-auto mb-6 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-[var(--primary-from)] to-[var(--primary-to)] rounded-full blur-3xl opacity-50 animate-pulse-glow"}),e.jsx(de,{className:"w-24 h-24 text-white z-10 drop-shadow-[0_0_20px_rgba(0,169,255,0.5)]"})]}),e.jsx("h1",{className:"text-3xl font-extrabold mb-2 bg-gradient-to-br from-white to-[var(--text-main)] bg-clip-text text-transparent",children:"أهلاً بك في عالمك الخاص"}),e.jsx("p",{className:"text-[var(--text-secondary)] mb-8",children:"لنبدأ ببناء شخصية صديقك. كيف يمكنني مناداتك؟"}),e.jsxs("form",{onSubmit:u,className:"space-y-5",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-5 pointer-events-none",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-[var(--text-secondary)]",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z",clipRule:"evenodd"})})}),e.jsx("input",{type:"text",value:t,onChange:d=>n(d.target.value),placeholder:"اكتب اسمك هنا...",className:"w-full bg-[var(--bg-dark)] text-white rounded-full py-3 pr-14 pl-5 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-dark)] focus:ring-[var(--primary-from)] transition border border-[var(--border-color)] placeholder:text-[var(--text-secondary)] h-14 text-lg",required:!0})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-5 pointer-events-none",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-[var(--text-secondary)]",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"})})}),e.jsx("input",{type:"text",value:o,onChange:d=>s(d.target.value),placeholder:"اختر اسماً لصديقك...",className:"w-full bg-[var(--bg-dark)] text-white rounded-full py-3 pr-14 pl-5 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-dark)] focus:ring-[var(--primary-from)] transition border border-[var(--border-color)] placeholder:text-[var(--text-secondary)] h-14 text-lg",required:!0})]}),e.jsx("button",{type:"submit",className:"w-full bg-gradient-to-br from-[var(--primary-from)] to-[var(--primary-to)] text-white font-bold py-3.5 px-4 rounded-full hover:shadow-lg hover:shadow-[var(--primary-from)]/30 transition-all duration-300 transform hover:scale-105 text-lg !mt-6",children:"تأكيد وبدء الرحلة"})]})]})})},be=[{mission:"اسألني عن الطقس اليوم",keyword:"weather"},{mission:"اطلب مني أن أصف لك صورة لقطة",keyword:"cat"},{mission:"قل لي نكتة",keyword:"joke"},{mission:"ما هو اقتباس اليوم الملهم؟",keyword:"quote"},{mission:"اطلب مني كتابة قصيدة قصيرة عن الصداقة",keyword:"poem"}],dt=r=>{switch(r){case"data_stream":return"bg-data-stream";case"holo_grid":return"bg-holo-grid";case"cyber_grid":return"bg-cyber-grid";case"solid":return"bg-solid";case"neon_nexus":default:return"bg-neon-nexus"}},mt=()=>{const[r,t]=m.useState("LOADING"),[n,o]=m.useState([]),[s,u]=m.useState(null),[d,v]=m.useState(!1),[p,h]=m.useState(!1),[b,j]=m.useState(!1),[k,C]=m.useState(!1),[g,w]=m.useState([]),[R,I]=m.useState(null),[T,S]=m.useState(""),[B,G]=m.useState(null),[V,N]=m.useState([]),D=m.useRef(null),Y=m.useRef(null),_=n.find(a=>a.id===s),H=(_==null?void 0:_.messages)??[],f=_==null?void 0:_.userData,se=m.useCallback((a,l={closeModal:!0})=>{if(!s)return;const i=f,c={...a,userAvatar:`https://api.dicebear.com/8.x/adventurer/svg?seed=${a.userName.trim()}`,aiAvatar:`https://api.dicebear.com/8.x/micah/svg?seed=${a.aiName.trim()}`};le(c),o(x=>x.map(M=>{const L={...M.userData,...c};return M.id===s?(((i==null?void 0:i.aiName)!==c.aiName||(i==null?void 0:i.userName)!==c.userName)&&(D.current=Q(c.aiName,c.userName,c.memory,M.messages)),{...M,userData:L,lastUpdated:Date.now()}):{...M,userData:L}})),l.closeModal&&j(!1)},[s,f]);m.useEffect(()=>{const a=()=>{const l=window.speechSynthesis.getVoices();l.length>0&&w(l.filter(i=>i.lang.startsWith("ar")))};return window.speechSynthesis.onvoiceschanged=a,a(),()=>{window.speechSynthesis.onvoiceschanged=null,window.speechSynthesis.cancel()}},[]),m.useEffect(()=>{"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(a=>console.log("Service Worker registered with scope:",a.scope)).catch(a=>console.log("Service Worker registration failed:",a))},[]),m.useEffect(()=>{"serviceWorker"in navigator&&"PeriodicSyncManager"in window&&navigator.serviceWorker.ready.then(async a=>{if(Notification.permission!=="granted"){try{await a.periodicSync.unregister("check-in-notification")}catch{}return}if(f!=null&&f.notificationsEnabled)try{(await a.periodicSync.getTags()).includes("check-in-notification")||await a.periodicSync.register("check-in-notification",{minInterval:7200*1e3})}catch(l){console.error("Periodic sync could not be registered!",l)}else try{await a.periodicSync.unregister("check-in-notification")}catch(l){console.error("Periodic sync could not be unregistered!",l)}})},[f==null?void 0:f.notificationsEnabled]),m.useEffect(()=>{setTimeout(async()=>{try{const l=localStorage.getItem("conversations");if(l){const i=JSON.parse(l);if(i.length>0){const c=i.sort((A,P)=>P.lastUpdated-A.lastUpdated);let x={...c[0].userData};const M=ce();let L=!1;if(x.lastInteractionDate!==M){L=!0;let A=x.dailyStreak||0;it(x.lastInteractionDate)?A++:A=1,x.dailyStreak=A;try{const P=await Fe(),W=JSON.parse(P.text);x.dailyMission={text:W.mission,keyword:W.keyword.toLowerCase(),completed:!1}}catch(P){console.error("Failed to fetch daily mission, using fallback.",P);const W=be[Math.floor(Math.random()*be.length)];x.dailyMission={text:W.mission,keyword:W.keyword,completed:!1}}}let y=c.map(A=>({...A,userData:{...A.userData,chatBackground:A.userData.chatBackground||"neon_nexus"}}));L&&(y=y.map(A=>({...A,userData:{...A.userData,dailyStreak:x.dailyStreak,dailyMission:x.dailyMission}})),le(x)),o(y);const E=y[0];u(E.id);const{aiName:F,userName:U,memory:K}=E.userData;D.current=Q(F,U,K||[],E.messages),t("CHAT")}else t("SETUP")}else t("SETUP")}catch(l){console.error("Failed to parse data from localStorage",l),localStorage.clear(),t("SETUP")}},1500)},[]),m.useEffect(()=>{if(r==="CHAT"&&n.length>0)try{const a=n.map(l=>({...l,messages:l.messages.map(({imageUrl:i,...c})=>({...c,base64Image:c.sender==="ai"?c.base64Image:void 0,mimeType:c.sender==="ai"?c.mimeType:void 0}))}));localStorage.setItem("conversations",JSON.stringify(a))}catch(a){console.error("Failed to save conversations",a)}},[n,r]),m.useEffect(()=>{Y.current&&(Y.current.scrollTop=Y.current.scrollHeight)},[H,p,V]);const ye=a=>{const l=`convo-${Date.now()}`,i={id:l,title:`محادثة مع ${a.aiName}`,messages:[{id:"init",text:`أهلاً يا ${a.userName}! أنا ${a.aiName}، ومبسوط جدًا إني هكون صديقك. يلا بينا نتكلم! 😊`,sender:"ai"}],userData:a,lastUpdated:Date.now()};o([i]),u(l),le(a),D.current=Q(a.aiName,a.userName,a.memory||[],[]),t("CHAT")},me=a=>{const l=n.find(i=>i.id===a);if(l){window.speechSynthesis.cancel(),I(null),u(a);const{aiName:i,userName:c,memory:x}=l.userData;D.current=Q(i,c,x||[],l.messages),C(!1)}},je=()=>{const a=n.sort((F,U)=>U.lastUpdated-F.lastUpdated)[0];if(!a)return;const l=a.userData,i=[`إزيك يا ${l.userName}! إيه الأخبار؟ يلا بينا نكمل كلام. 😄`,`أهلاً يا صاحبي ${l.userName}! عامل إيه النهاردة؟ مستعد لدردشة جديدة؟ 🤔`],c=i[Math.floor(Math.random()*i.length)],x=`convo-${Date.now()}`,M={id:x,title:"محادثة جديدة",messages:[{id:"init",text:c,sender:"ai"}],userData:l,lastUpdated:Date.now()};o(F=>[M,...F.sort((U,K)=>K.lastUpdated-U.lastUpdated)]),u(x);const{aiName:L,userName:y,memory:E}=l;D.current=Q(L,y,E||[],[]),C(!1)},Ne=a=>{const l=n.filter(i=>i.id!==a);if(o(l),s===a)if(window.speechSynthesis.cancel(),l.length>0){const i=l.sort((c,x)=>x.lastUpdated-c.lastUpdated)[0];me(i.id)}else u(null),localStorage.removeItem("conversations"),t("SETUP")},ke=(a,l,i)=>{o(c=>c.map(x=>x.id===a?{...x,messages:x.messages.map(M=>M.id===l?{...M,...i}:M),lastUpdated:Date.now()}:x))},$=(a,l)=>{o(i=>i.map(c=>c.id===a?{...c,messages:[...c.messages,l],lastUpdated:Date.now()}:c))},Ce=a=>{s&&o(l=>l.map(i=>{const c=i.userData.memory||[];if(!c.includes(a)){const x={...i.userData,memory:[...c,a]};return{...i,userData:x}}return i}))},Se=(a,l)=>{if(window.speechSynthesis.cancel(),R===l){I(null);return}const i=new SpeechSynthesisUtterance(a),c=g.find(x=>x.lang==="ar-EG")||g.find(x=>x.lang.startsWith("ar-"));c?(i.voice=c,i.lang=c.lang):i.lang="ar-EG",i.rate=.95,i.pitch=1,i.onstart=()=>I(l),i.onend=()=>I(null),i.onerror=()=>{I(null),console.error("Speech synthesis error")},window.speechSynthesis.speak(i)},Me=async()=>{if(!(!s||!f)){v(!0),$(s,{id:`ai-${Date.now()}`,sender:"ai",text:"بالتأكيد! لنلعب قليلاً. إليك سؤال..."}),h(!0);try{const a=await Oe(),l=JSON.parse(a.text),i={id:`trivia-${Date.now()}`,sender:"ai",text:"",type:"trivia",trivia:{question:l.question,options:l.options,answer:l.answer}};$(s,i)}catch(a){console.error("Failed to start trivia",a),$(s,{id:`err-${Date.now()}`,sender:"ai",text:re(a)})}finally{v(!1),h(!1)}}},Re=(a,l)=>{if(!s)return;const i=H.find(y=>y.id===a);if(!i||!i.trivia||i.trivia.userAnswer)return;const c=l===i.trivia.answer,x={...i.trivia,userAnswer:l,isCorrect:c};ke(s,a,{trivia:x});const M=c?"رائع! إجابة صحيحة. 🎉":`إجابة خاطئة. الإجابة الصحيحة هي: "${i.trivia.answer}".`,L={id:`ai-resp-${Date.now()}`,sender:"ai",text:`${M} هل تريد أن نلعب جولة أخرى؟`};setTimeout(()=>$(s,L),500)},Te=a=>{a.type==="generated_image"&&G(a)},Ae=async(a,l)=>{if(!(!s||!a.originalPrompt)){h(!0),G(null);try{$(s,{id:`user-edit-${Date.now()}`,sender:"user",text:`تعديل على الصورة: "${l}"`});const i=await Pe(a.originalPrompt,l),c=await ve(i),x={id:`ai-edited-${Date.now()}`,sender:"ai",type:"generated_image",text:"تفضل، هذه هي الصورة بعد التعديل. هل أعجبتك؟",base64Image:c,originalPrompt:i};$(s,x)}catch(i){console.error("Failed to edit image:",i),$(s,{id:`err-${Date.now()}`,sender:"ai",text:re(i)})}finally{h(!1)}}},ue=m.useCallback(async(a,l)=>{if(!f)return;const i=await Ge(f.userName,f.aiName,a,l);setTimeout(()=>{const c=H[H.length-1];(c==null?void 0:c.sender)==="ai"&&(c==null?void 0:c.text)===l&&N(i)},500)},[f,H]),Ie=a=>{N([]),S(a),oe(a)},oe=async(a,l)=>{var x,M,L;if(!D.current||d||!s||!f||!a&&!l)return;if(N([]),/تريفيا|اسئله|أسئلة|لعبة|game|trivia/i.test(a)){S(""),await Me();return}if(v(!0),S(""),f.lastInteractionDate!==ce()&&se({...f,lastInteractionDate:ce()},{closeModal:!1}),f.dailyMission&&!f.dailyMission.completed&&a.toLowerCase().includes(f.dailyMission.keyword)){const y={...f,dailyMission:{...f.dailyMission,completed:!0}};se(y,{closeModal:!1}),$(s,{id:`mission-${Date.now()}`,sender:"ai",type:"mission_completed",text:"أحسنت! لقد أكملت مهمة اليوم."})}let i,c;if(l)try{const y=await at(l),E=l.type,U=E.startsWith("image/")?URL.createObjectURL(l):void 0;U&&(c=U),i={id:`user-${Date.now()}`,text:a,sender:"user",imageUrl:U,base64Image:y,mimeType:E,fileName:l.name}}catch(y){console.error("Error processing user file:",y),$(s,{id:`error-file-${Date.now()}`,text:"عذراً، لم أتمكن من قراءة الملف المرفق.",sender:"ai"}),v(!1);return}else i={id:`user-${Date.now()}`,text:a,sender:"user"};$(s,i),(_==null?void 0:_.messages.length)<4&&a&&_.title==="محادثة جديدة"&&o(y=>y.map(E=>E.id===s?{...E,title:a.substring(0,40)+(a.length>40?"...":""),lastUpdated:Date.now()}:E)),h(!0);try{const y=[];a&&y.push({text:a}),i.base64Image&&i.mimeType&&y.push({inlineData:{data:i.base64Image,mimeType:i.mimeType}});const E=await D.current.sendMessage({message:y});h(!1);let F=E.text||"";const U=(L=(M=(x=E.candidates)==null?void 0:x[0])==null?void 0:M.groundingMetadata)==null?void 0:L.groundingChunks,K=/<THINK>MEMORIZE: (.*?)<\/THINK>/s,A=F.match(K);A&&A[1]&&Ce(A[1].trim());let P=F.replace(K,"").trim();const W=/<GENERATE_IMAGE_PROMPT>(.*?)<\/GENERATE_IMAGE_PROMPT>/s,ne=P.match(W);if(ne&&ne[1]){h(!0);const J=ne[1].trim();try{const z=await ve(J),ee={id:`ai-gen-${Date.now()}`,sender:"ai",type:"generated_image",text:"بالتأكيد، تم إنشاء هذه الصورة خصيصًا لك.",base64Image:z,originalPrompt:J,mimeType:"image/jpeg"};$(s,ee),ue(a,ee.text)}catch(z){console.error("Image generation failed:",z),$(s,{id:`error-img-${Date.now()}`,text:re(z),sender:"ai"})}h(!1);return}const ie=P.match(/\[IMAGE_URL\](.*?)\[\/IMAGE_URL\]/s);let q;if(ie&&ie[1]){const J=ie[1].trim(),z=P.replace(/\[IMAGE_URL\].*?\[\/IMAGE_URL\]/s,"").trim();q={id:`ai-${Date.now()}`,sender:"ai",text:z,imageUrl:J,mimeType:"image/png"}}else q={id:`ai-${Date.now()}`,text:P,sender:"ai"};if((q.text||q.imageUrl)&&($(s,q),q.text&&ue(a,q.text)),U&&U.length>0){const J=U.map((z,ee)=>{var xe,he;const te=(xe=z==null?void 0:z.web)==null?void 0:xe.uri,ze=((he=z==null?void 0:z.web)==null?void 0:he.title)||te;return typeof te=="string"&&te?`${ee+1}. [${String(ze).replace(/[\[\]]/g,"")}](${te})`:null}).filter(Boolean).join(`
`);if(J){const z={id:`source-${Date.now()}`,sender:"ai",type:"source_info",text:`**المصادر:**
${J}`};$(s,z)}}}catch(y){console.error("Error sending message:",y),$(s,{id:`error-${Date.now()}`,text:re(y),sender:"ai"})}finally{v(!1),h(!1),c&&URL.revokeObjectURL(c)}};if(r==="LOADING")return e.jsx(lt,{});if(r==="SETUP"||!f||!_)return e.jsx(ct,{onSetupComplete:ye});const $e=H.length===1&&H[0].id==="init",Ee=dt(f.chatBackground);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`flex flex-col h-screen bg-transparent text-white md:max-w-5xl md:mx-auto md:border-x md:border-[var(--border-color)] md:shadow-2xl md:shadow-black/50 relative overflow-hidden ${Ee}`,dir:"rtl",children:[e.jsx("div",{className:"absolute top-0 right-0 left-0 h-96 bg-gradient-to-b from-[var(--bg-dark)]/80 via-[var(--bg-surface)]/20 to-transparent -z-10"}),e.jsx(Ve,{aiName:f.aiName,aiAvatar:f.aiAvatar,dailyStreak:f.dailyStreak||0,onOpenSettings:()=>j(!0),onToggleSidebar:()=>C(!0)}),e.jsxs("main",{ref:Y,className:"flex-1 overflow-y-auto p-2 sm:p-4 flex flex-col",children:[e.jsxs("div",{className:"flex-grow space-y-2",children:[$e?e.jsx(et,{onSendMessage:a=>oe(a)}):H.map(a=>e.jsx(Je,{message:a,avatar:a.sender==="ai"?f.aiAvatar:f.userAvatar,onPlayAudio:Se,isSpeaking:R===a.id,onAnswerTrivia:Re,onEditImage:Te},a.id)),p&&e.jsx(Ke,{})]}),V.length>0&&!p&&e.jsx("div",{className:"flex justify-center items-center gap-2 flex-wrap p-2 animate-in fade-in",children:V.map((a,l)=>e.jsx("button",{onClick:()=>Ie(a),className:"py-2 px-4 rounded-full bg-[var(--bg-surface)]/80 backdrop-blur-sm hover:bg-[var(--bg-surface-hover)] text-sm text-[var(--text-secondary)] hover:text-white transition-all border border-[var(--border-color)]",children:a},l))})]}),e.jsxs("div",{className:"flex-shrink-0",children:[f.dailyMission&&!f.dailyMission.completed&&e.jsx(tt,{missionText:f.dailyMission.text}),e.jsx(Ye,{onSendMessage:oe,isLoading:d,inputValue:T,setInputValue:S})]})]}),e.jsx(Qe,{isOpen:k,onClose:()=>C(!1),conversations:n,activeConversationId:s,onSelectConversation:me,onNewChat:je,onDeleteConversation:Ne}),e.jsx(Ze,{isOpen:b,onClose:()=>j(!1),onSave:se,userData:f}),e.jsx(rt,{isOpen:!!B,onClose:()=>G(null),messageToEdit:B,onConfirmEdit:Ae})]})},we=document.getElementById("root");if(!we)throw new Error("Could not find root element to mount to");const ut=Be.createRoot(we);ut.render(e.jsx(De.StrictMode,{children:e.jsx(mt,{})}));
